<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Database Setup - COPY THIS</title>
    <style>
        body {
            font-family: Arial;
            background: #1a1a2e;
            color: white;
            padding: 40px;
        }

        .box {
            background: #0d0d15;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        button {
            background: #10b981;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background: #059669;
        }

        h1 {
            color: #10b981;
        }

        pre {
            white-space: pre-wrap;
            font-size: 11px;
            max-height: 200px;
            overflow: auto;
        }

        .step {
            background: #2d2d3a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .num {
            background: #3b82f6;
            padding: 5px 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
    </style>
</head>

<body>

    <h1>üõ†Ô∏è Workers United Database Setup</h1>

    <div class="step">
        <span class="num">1</span> <strong>Click this button to copy the SQL:</strong>
        <br><br>
        <button onclick="copyPart1()" id="btn1">üìã COPY PART 1 (Tables)</button>
        <span id="status1"></span>
    </div>

    <div class="step">
        <span class="num">2</span> <strong>Go to <a
                href="https://supabase.com/dashboard/project/qdwhwlusxjjtlinmpwms/sql/new" target="_blank"
                style="color:#3b82f6">Supabase SQL Editor</a></strong>
        <br><br>
        Press Ctrl+V to paste, then click <strong>Run</strong>
    </div>

    <div class="step">
        <span class="num">3</span> <strong>After Part 1 succeeds, copy Part 2:</strong>
        <br><br>
        <button onclick="copyPart2()" id="btn2">üìã COPY PART 2 (Policies)</button>
        <span id="status2"></span>
    </div>

    <div class="box">
        <strong>Preview (Part 1):</strong>
        <pre id="preview">Loading...</pre>
    </div>

    <script>
        const part1 = `-- PART 1: TABLES
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TABLE IF NOT EXISTS profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT UNIQUE NOT NULL,
    full_name TEXT,
    avatar_url TEXT,
    user_type TEXT NOT NULL DEFAULT 'candidate' CHECK (user_type IN ('candidate', 'employer', 'admin')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS candidates (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    profile_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    phone TEXT,
    country TEXT,
    preferred_job TEXT,
    experience_years INTEGER,
    cv_url TEXT,
    passport_url TEXT,
    queue_position INTEGER,
    queue_joined_at TIMESTAMPTZ,
    entry_fee_paid BOOLEAN DEFAULT FALSE,
    entry_payment_id UUID,
    status TEXT DEFAULT 'NEW',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS employers (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    profile_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    company_name TEXT NOT NULL DEFAULT 'My Company',
    company_website TEXT,
    country TEXT,
    industry TEXT,
    employees_count INTEGER,
    pib VARCHAR(8),
    accommodation_address TEXT,
    min_salary_rsd DECIMAL(10,2),
    company_address TEXT,
    contact_phone TEXT,
    status TEXT DEFAULT 'PENDING',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS matches (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    candidate_id UUID REFERENCES candidates(id) ON DELETE CASCADE,
    employer_id UUID REFERENCES employers(id) ON DELETE CASCADE,
    status TEXT DEFAULT 'PENDING',
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS payments (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    profile_id UUID REFERENCES profiles(id) ON DELETE SET NULL,
    candidate_id UUID REFERENCES candidates(id) ON DELETE SET NULL,
    offer_id UUID,
    payment_type TEXT NOT NULL,
    amount_cents INTEGER NOT NULL,
    currency TEXT DEFAULT 'USD',
    stripe_session_id TEXT,
    stripe_payment_intent_id TEXT,
    status TEXT DEFAULT 'pending',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS job_requests (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    employer_id UUID REFERENCES employers(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    destination_country TEXT DEFAULT 'Serbia',
    industry TEXT,
    positions_count INTEGER DEFAULT 1,
    positions_filled INTEGER DEFAULT 0,
    accommodation_address TEXT,
    salary_rsd DECIMAL(10,2),
    work_schedule TEXT,
    contract_duration_months INTEGER DEFAULT 12,
    experience_required_years INTEGER DEFAULT 0,
    salary_min DECIMAL(10,2),
    salary_max DECIMAL(10,2),
    salary_currency TEXT DEFAULT 'EUR',
    status TEXT DEFAULT 'open',
    auto_match_triggered BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS offers (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    job_request_id UUID REFERENCES job_requests(id) ON DELETE CASCADE,
    candidate_id UUID REFERENCES candidates(id) ON DELETE CASCADE,
    status TEXT DEFAULT 'pending',
    offered_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '24 hours'),
    accepted_at TIMESTAMPTZ,
    confirmation_payment_id UUID REFERENCES payments(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS documents (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    candidate_id UUID REFERENCES candidates(id) ON DELETE CASCADE,
    document_type TEXT NOT NULL,
    file_url TEXT NOT NULL,
    file_name TEXT,
    file_size_bytes INTEGER,
    mime_type TEXT,
    verification_status TEXT DEFAULT 'pending',
    ai_extracted_data JSONB DEFAULT '{}',
    ai_confidence_score DECIMAL(3,2),
    ai_notes TEXT,
    ai_processed_at TIMESTAMPTZ,
    name_matches BOOLEAN,
    data_discrepancies JSONB DEFAULT '{}',
    reviewed_by UUID,
    reviewed_at TIMESTAMPTZ,
    review_notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS contract_data (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    match_id UUID REFERENCES matches(id) ON DELETE CASCADE,
    candidate_full_name TEXT,
    candidate_passport_number TEXT,
    candidate_nationality TEXT,
    candidate_date_of_birth DATE,
    candidate_passport_expiry DATE,
    candidate_address TEXT,
    employer_company_name TEXT,
    employer_pib TEXT,
    employer_address TEXT,
    employer_representative_name TEXT,
    job_title TEXT,
    salary_rsd DECIMAL(10,2),
    accommodation_address TEXT,
    contract_duration_months INTEGER,
    work_schedule TEXT,
    start_date DATE,
    contract_template TEXT,
    contract_pdf_url TEXT,
    generated_at TIMESTAMPTZ,
    candidate_signed_at TIMESTAMPTZ,
    employer_signed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);`;

        const part2 = `-- PART 2: POLICIES & FUNCTIONS
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE candidates ENABLE ROW LEVEL SECURITY;
ALTER TABLE employers ENABLE ROW LEVEL SECURITY;
ALTER TABLE matches ENABLE ROW LEVEL SECURITY;
ALTER TABLE payments ENABLE ROW LEVEL SECURITY;
ALTER TABLE job_requests ENABLE ROW LEVEL SECURITY;
ALTER TABLE offers ENABLE ROW LEVEL SECURITY;
ALTER TABLE documents ENABLE ROW LEVEL SECURITY;
ALTER TABLE contract_data ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "profiles_select" ON profiles;
CREATE POLICY "profiles_select" ON profiles FOR SELECT USING (
    auth.uid() = id OR EXISTS (SELECT 1 FROM public.profiles p WHERE p.id = auth.uid() AND p.user_type = 'admin')
);

DROP POLICY IF EXISTS "profiles_update" ON profiles;
CREATE POLICY "profiles_update" ON profiles FOR UPDATE USING (auth.uid() = id);

DROP POLICY IF EXISTS "profiles_insert" ON profiles;
CREATE POLICY "profiles_insert" ON profiles FOR INSERT WITH CHECK (auth.uid() = id);

DROP POLICY IF EXISTS "candidates_select" ON candidates;
CREATE POLICY "candidates_select" ON candidates FOR SELECT USING (
    profile_id = auth.uid() OR EXISTS (SELECT 1 FROM public.profiles p WHERE p.id = auth.uid() AND p.user_type IN ('admin', 'employer'))
);

DROP POLICY IF EXISTS "candidates_update" ON candidates;
CREATE POLICY "candidates_update" ON candidates FOR UPDATE USING (
    profile_id = auth.uid() OR EXISTS (SELECT 1 FROM public.profiles p WHERE p.id = auth.uid() AND p.user_type = 'admin')
);

DROP POLICY IF EXISTS "candidates_insert" ON candidates;
CREATE POLICY "candidates_insert" ON candidates FOR INSERT WITH CHECK (profile_id = auth.uid());

DROP POLICY IF EXISTS "employers_select" ON employers;
CREATE POLICY "employers_select" ON employers FOR SELECT USING (
    profile_id = auth.uid() OR EXISTS (SELECT 1 FROM public.profiles p WHERE p.id = auth.uid() AND p.user_type = 'admin')
);

DROP POLICY IF EXISTS "employers_update" ON employers;
CREATE POLICY "employers_update" ON employers FOR UPDATE USING (profile_id = auth.uid());

DROP POLICY IF EXISTS "employers_insert" ON employers;
CREATE POLICY "employers_insert" ON employers FOR INSERT WITH CHECK (profile_id = auth.uid());

DROP POLICY IF EXISTS "matches_select" ON matches;
CREATE POLICY "matches_select" ON matches FOR SELECT USING (
    EXISTS (SELECT 1 FROM public.candidates c WHERE c.id = candidate_id AND c.profile_id = auth.uid()) OR
    EXISTS (SELECT 1 FROM public.employers e WHERE e.id = employer_id AND e.profile_id = auth.uid()) OR
    EXISTS (SELECT 1 FROM public.profiles p WHERE p.id = auth.uid() AND p.user_type = 'admin')
);

DROP POLICY IF EXISTS "payments_select" ON payments;
CREATE POLICY "payments_select" ON payments FOR SELECT USING (
    profile_id = auth.uid() OR EXISTS (SELECT 1 FROM public.profiles p WHERE p.id = auth.uid() AND p.user_type = 'admin')
);

DROP POLICY IF EXISTS "payments_insert" ON payments;
CREATE POLICY "payments_insert" ON payments FOR INSERT WITH CHECK (profile_id = auth.uid());

DROP POLICY IF EXISTS "job_requests_select" ON job_requests;
CREATE POLICY "job_requests_select" ON job_requests FOR SELECT USING (
    EXISTS (SELECT 1 FROM public.employers e WHERE e.id = employer_id AND e.profile_id = auth.uid()) OR
    EXISTS (SELECT 1 FROM public.profiles p WHERE p.id = auth.uid() AND p.user_type IN ('admin', 'candidate'))
);

DROP POLICY IF EXISTS "job_requests_insert" ON job_requests;
CREATE POLICY "job_requests_insert" ON job_requests FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM public.employers e WHERE e.id = employer_id AND e.profile_id = auth.uid())
);

DROP POLICY IF EXISTS "offers_select" ON offers;
CREATE POLICY "offers_select" ON offers FOR SELECT USING (
    EXISTS (SELECT 1 FROM public.candidates c WHERE c.id = candidate_id AND c.profile_id = auth.uid()) OR
    EXISTS (SELECT 1 FROM public.profiles p WHERE p.id = auth.uid() AND p.user_type = 'admin')
);

DROP POLICY IF EXISTS "documents_select" ON documents;
CREATE POLICY "documents_select" ON documents FOR SELECT USING (
    EXISTS (SELECT 1 FROM public.candidates c WHERE c.id = candidate_id AND c.profile_id = auth.uid()) OR
    EXISTS (SELECT 1 FROM public.profiles p WHERE p.id = auth.uid() AND p.user_type = 'admin')
);

DROP POLICY IF EXISTS "documents_insert" ON documents;
CREATE POLICY "documents_insert" ON documents FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM public.candidates c WHERE c.id = candidate_id AND c.profile_id = auth.uid())
);

DROP POLICY IF EXISTS "contract_data_select" ON contract_data;
CREATE POLICY "contract_data_select" ON contract_data FOR SELECT USING (
    EXISTS (SELECT 1 FROM public.profiles p WHERE p.id = auth.uid() AND p.user_type = 'admin')
);

CREATE OR REPLACE FUNCTION public.handle_new_user() RETURNS trigger AS $$
BEGIN
    INSERT INTO public.profiles (id, email, full_name, user_type)
    VALUES (NEW.id, NEW.email, COALESCE(NEW.raw_user_meta_data->>'full_name', ''), COALESCE(NEW.raw_user_meta_data->>'user_type', 'candidate'));
    IF COALESCE(NEW.raw_user_meta_data->>'user_type', 'candidate') = 'candidate' THEN
        INSERT INTO public.candidates (profile_id) VALUES (NEW.id);
    ELSIF NEW.raw_user_meta_data->>'user_type' = 'employer' THEN
        INSERT INTO public.employers (profile_id, company_name) VALUES (NEW.id, COALESCE(NEW.raw_user_meta_data->>'company_name', 'My Company'));
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created AFTER INSERT ON auth.users FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

CREATE OR REPLACE FUNCTION update_updated_at_column() RETURNS TRIGGER AS $$
BEGIN NEW.updated_at = NOW(); RETURN NEW; END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION get_next_queue_position() RETURNS INTEGER AS $$
BEGIN RETURN (SELECT COALESCE(MAX(queue_position), 0) + 1 FROM candidates WHERE entry_fee_paid = TRUE); END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION add_candidate_to_queue(p_candidate_id UUID) RETURNS INTEGER AS $$
DECLARE new_pos INTEGER;
BEGIN
    new_pos := get_next_queue_position();
    UPDATE candidates SET queue_position = new_pos, queue_joined_at = NOW(), entry_fee_paid = TRUE, status = 'IN_QUEUE' WHERE id = p_candidate_id;
    RETURN new_pos;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION auto_match_candidates(p_job_request_id UUID) RETURNS INTEGER AS $$
DECLARE positions_needed INTEGER; matched_count INTEGER := 0; candidate_record RECORD;
BEGIN
    SELECT positions_count - positions_filled INTO positions_needed FROM job_requests WHERE id = p_job_request_id;
    UPDATE job_requests SET status = 'matching', auto_match_triggered = TRUE WHERE id = p_job_request_id;
    FOR candidate_record IN SELECT id FROM candidates WHERE status = 'IN_QUEUE' AND entry_fee_paid = TRUE ORDER BY queue_position ASC LIMIT positions_needed
    LOOP
        INSERT INTO offers (job_request_id, candidate_id, status, expires_at) VALUES (p_job_request_id, candidate_record.id, 'pending', NOW() + INTERVAL '24 hours');
        UPDATE candidates SET status = 'OFFER_PENDING' WHERE id = candidate_record.id;
        matched_count := matched_count + 1;
    END LOOP;
    RETURN matched_count;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION trigger_auto_match_on_job_created() RETURNS TRIGGER AS $$
BEGIN IF NEW.status = 'open' THEN PERFORM auto_match_candidates(NEW.id); END IF; RETURN NEW; END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS on_job_request_created ON job_requests;
CREATE TRIGGER on_job_request_created AFTER INSERT ON job_requests FOR EACH ROW EXECUTE FUNCTION trigger_auto_match_on_job_created();`;

        document.getElementById('preview').textContent = part1.substring(0, 500) + '...';

        function copyPart1() {
            navigator.clipboard.writeText(part1).then(() => {
                document.getElementById('btn1').textContent = '‚úÖ COPIED!';
                document.getElementById('btn1').style.background = '#3b82f6';
                document.getElementById('status1').textContent = ' Now paste in Supabase and click Run';
            });
        }

        function copyPart2() {
            navigator.clipboard.writeText(part2).then(() => {
                document.getElementById('btn2').textContent = '‚úÖ COPIED!';
                document.getElementById('btn2').style.background = '#3b82f6';
                document.getElementById('status2').textContent = ' Now paste in Supabase and click Run';
            });
        }
    </script>
</body>

</html>